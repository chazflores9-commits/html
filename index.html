<!-- add this script at the bottom of menu.html, before </body> -->
<script>
/*
  DUI <-> HTML bridge for OSINT menu
  - Listens for window 'message' events (DUI -> HTML).
  - Sends messages back to Lua via fetch('https://<resource>/dui', {...})
    Replace REPLACE_WITH_RESOURCE_NAME below with your resource name.
*/

/* ----- CONFIG ----- */
// Replace this with the resource name that will receive messages from the page.
// Example: if your resource folder is named "osint", set RESOURCE_NAME = "osint"
const RESOURCE_NAME = "REPLACE_WITH_RESOURCE_NAME";

/* ----- Helpers ----- */
function log(...args) { console.log("[dui-html]", ...args); }

// safe parse (message may be stringified JSON or an object)
function parseMsg(payload) {
  try {
    if (typeof payload === "string") return JSON.parse(payload);
    return payload;
  } catch (e) {
    log("Failed to parse message payload:", e, payload);
    return null;
  }
}

/* ----- Sending messages back to Lua ----- */
/*
  Call sendToLua('ACTION_NAME', { key: value })
  On Lua side register a NUI callback for endpoint name 'dui' (see Lua examples below).
*/
function sendToLua(action, data = {}) {
  if (!RESOURCE_NAME || RESOURCE_NAME === "REPLACE_WITH_RESOURCE_NAME") {
    console.warn("sendToLua: please set RESOURCE_NAME in the HTML to your resource name.");
    return;
  }

  const payload = { action, data };

  fetch(`https://${RESOURCE_NAME}/dui`, {
    method: "POST",
    headers: { "Content-Type": "application/json; charset=UTF-8" },
    body: JSON.stringify(payload)
  }).then(r => {
    // optional success handling
    // r.json().then(j=>console.log("Lua reply:", j)).catch(()=>{})
  }).catch(err => {
    console.error("Failed to send message to Lua:", err, payload);
  });
}

/* ----- UI helpers used by handlers ----- */
function findMenuItems() {
  return Array.from(document.querySelectorAll(".menu-item"));
}
function setSelectedIndex(index) {
  const items = findMenuItems();
  items.forEach((el, i) => {
    if (i === index) el.classList.add("menu-item-selected");
    else el.classList.remove("menu-item-selected");
  });
}
function updateServerLeftModel(label, model) {
  // Example: find a menu-item with text == label and show model as tooltip/append text
  const items = findMenuItems();
  for (const el of items) {
    const t = el.querySelector(".menu-item-text");
    if (!t) continue;
    if (t.textContent.trim() === label) {
      // add or update a small sublabel
      let sub = el.querySelector(".sub-label");
      if (!sub) {
        sub = document.createElement("div");
        sub.className = "sub-label";
        sub.style.fontSize = "11px";
        sub.style.opacity = "0.9";
        sub.style.marginLeft = "8px";
        sub.style.color = "#cfe9ff";
        el.appendChild(sub);
      }
      sub.textContent = String(model);
      return;
    }
  }
}

/* ----- Incoming message handler (DUI -> HTML) ----- */
window.addEventListener("message", (ev) => {
  const raw = ev.data;
  const msg = parseMsg(raw);
  if (!msg) return;

  // message format expected: { action: "...", data: {...} }
  const action = msg.action || msg.type || null;
  const data = msg.data || msg.payload || {};

  if (!action) return;

  // handle a few common actions from your Lua OSINT file
  switch (action) {
    case "UPDATE_TOGGLE_STATE":
      // data: { toggleName, isToggled }
      // Example: highlight UI item with same text as toggleName
      {
        const name = data.toggleName || data.name || "";
        const toggled = !!data.isToggled;
        const items = findMenuItems();
        for (let i = 0; i < items.length; i++) {
          const el = items[i];
          const t = el.querySelector(".menu-item-text");
          if (!t) continue;
          if (t.textContent.trim().toLowerCase() === String(name).trim().toLowerCase()) {
            if (toggled) el.classList.add("menu-item-selected");
            else el.classList.remove("menu-item-selected");
          }
        }
      }
      break;

    case "UPDATE_SERVER_LEFT_MODEL":
      // data: { label, model }
      updateServerLeftModel(data.label, data.model);
      break;

    case "GO_BACK_TO_MAIN":
      // Example: clear sublabels and remove selection
      setSelectedIndex(-1);
      break;

    case "UPDATE_SERVER_RIGHT_TOGGLE":
      // data: { label, isToggled }
      // We'll find a menu item with that label and toggle its class
      {
        const label = data.label || "";
        const isToggled = !!data.isToggled;
        const items = findMenuItems();
        for (const el of items) {
          const t = el.querySelector(".menu-item-text");
          if (t && t.textContent.trim() === label) {
            if (isToggled) el.classList.add("menu-item-selected");
            else el.classList.remove("menu-item-selected");
          }
        }
      }
      break;

    case "UPDATE_SERVER_TOGGLE_INDEX":
      // data: { toggleName, isToggled } (server toggles)
      // treat similarly to UPDATE_TOGGLE_STATE
      {
        const name = data.toggleName || data.toggle || "";
        const isToggled = !!data.isToggled;
        const items = findMenuItems();
        for (const el of items) {
          const t = el.querySelector(".menu-item-text");
          if (t && t.textContent.trim() === name) {
            if (isToggled) el.classList.add("menu-item-selected");
            else el.classList.remove("menu-item-selected");
          }
        }
      }
      break;

    case "SET_SERVER_OPTIONS_FOCUS":
      // optional: data: { side, index }
      // if index provided, highlight that index
      if (typeof data.index === "number") setSelectedIndex(data.index);
      break;

    /* Add any more action handlers you need here. */
    default:
      // console.debug("Unhandled DUI message action:", action, data);
      break;
  }
});

/* ----- UI -> Lua: Hook clicks/toggles so user actions are sent back ----- */
document.addEventListener("DOMContentLoaded", () => {
  // click handler for menu items that sends their label as a 'SELECT' action
  const items = findMenuItems();
  items.forEach((el, idx) => {
    el.addEventListener("click", () => {
      const labelEl = el.querySelector(".menu-item-text");
      const label = labelEl ? labelEl.textContent.trim() : `item_${idx}`;
      // example message to Lua: action SELECT_MENU_ITEM
      sendToLua("SELECT_MENU_ITEM", { label, index: idx });
    });
  });

  // keyboard example: arrow keys to send navigation events
  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowUp") sendToLua("NAVIGATE", { dir: "up" });
    if (e.key === "ArrowDown") sendToLua("NAVIGATE", { dir: "down" });
    if (e.key === "Enter") sendToLua("ENTER", {});
    if (e.key === "Escape") sendToLua("BACK", {});
  });
});

/* ----- Debug helper exposed to console ----- */
window._dui = {
  sendToLua,
  setSelectedIndex,
  updateServerLeftModel,
  parseMsg
};

log("DUI bridge initialized. RESOURCE_NAME =", RESOURCE_NAME);
</script>
